#!/bin/sh /etc/rc.common

START=99
STOP=10

USE_PROCD=1

PROG=/usr/bin/pansou-openwrt
CONF_DIR=/etc/pansou
CONF_FILE=$CONF_DIR/config.yaml
LOG_FILE=/var/log/pansou.log

# 从UCI配置生成YAML配置
generate_config() {
	local enabled port autostart
	local concurrency timeout cache_ttl
	local tg_enabled check_timeout proxy
	local plugins_enabled
	
	# 读取配置
	config_load pansou
	
	# 服务配置
	config_get enabled config enabled 1
	config_get port config port 8888
	config_get autostart config autostart 1
	
	# 搜索配置
	config_get concurrency search concurrency 5
	config_get timeout search timeout 30
	config_get cache_ttl search cache_ttl 60
	
	# Telegram配置
	config_get tg_enabled telegram enabled 1
	config_get check_timeout telegram check_timeout 5
	config_get proxy telegram proxy ''
	
	# 插件配置
	config_get plugins_enabled plugins enabled 1
	
	# 创建配置目录
	mkdir -p $CONF_DIR
	
	# 生成YAML配置文件
	cat > $CONF_FILE <<EOF
# PanSou OpenWrt配置文件（自动生成）

server:
  port: $port
  enabled: $([ "$enabled" = "1" ] && echo "true" || echo "false")
  autostart: $([ "$autostart" = "1" ] && echo "true" || echo "false")

search:
  concurrency: $concurrency
  timeout: $timeout
  cache_ttl: $cache_ttl

telegram:
  enabled: $([ "$tg_enabled" = "1" ] && echo "true" || echo "false")
  channels:
EOF
	
	# 添加Telegram频道
	config_list_foreach telegram channels add_channel
	
	cat >> $CONF_FILE <<EOF
  check_timeout: $check_timeout
  proxy: "$proxy"

plugins:
  enabled: $([ "$plugins_enabled" = "1" ] && echo "true" || echo "false")
  list:
EOF
	
	# 添加插件配置
	add_plugin_config "xys" 2
	add_plugin_config "miaoso" 3
	add_plugin_config "jutoushe" 1
	add_plugin_config "alupan" 2
	add_plugin_config "mikuclub" 2
	add_plugin_config "ypfxw" 3
	add_plugin_config "kkmao" 3
	add_plugin_config "clxiong" 2
	add_plugin_config "ash" 2
	add_plugin_config "qingying" 3
	add_plugin_config "meitizy" 3
	add_plugin_config "wuji" 3
	add_plugin_config "dyyj" 3
	add_plugin_config "labi" 3
	add_plugin_config "zxzj" 3
	add_plugin_config "ddys" 3
	add_plugin_config "lou1" 2
	add_plugin_config "panyq" 1
	
	cat >> $CONF_FILE <<EOF

cloud_types:
  enabled:
EOF
	
	# 添加网盘类型配置
	add_cloud_type "baidu"
	add_cloud_type "aliyun"
	add_cloud_type "quark"
	add_cloud_type "tianyi"
	add_cloud_type "uc"
	add_cloud_type "mobile"
	add_cloud_type "115"
	add_cloud_type "pikpak"
	add_cloud_type "xunlei"
	add_cloud_type "123"
	add_cloud_type "magnet"
	add_cloud_type "ed2k"
	
	cat >> $CONF_FILE <<EOF

logging:
  level: info
  file: $LOG_FILE
EOF
}

add_channel() {
	echo "    - $1" >> $CONF_FILE
}

add_plugin_config() {
	local name=$1
	local priority=$2
	local enabled
	
	config_get enabled plugins "plugin_$name" 1
	
	cat >> $CONF_FILE <<EOF
    $name:
      enabled: $([ "$enabled" = "1" ] && echo "true" || echo "false")
      priority: $priority
EOF
}

add_cloud_type() {
	local type=$1
	local enabled
	
	config_get enabled cloud_types "type_$type" 1
	
	if [ "$enabled" = "1" ]; then
		echo "    - $type" >> $CONF_FILE
	fi
}

start_service() {
	local enabled
	
	config_load pansou
	config_get enabled config enabled 1
	
	[ "$enabled" = "0" ] && {
		echo "PanSou服务未启用"
		return 1
	}
	
	# 生成配置文件
	generate_config
	
	# 启动服务
	procd_open_instance
	procd_set_param command $PROG -config $CONF_FILE
	procd_set_param respawn
	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_set_param file $CONF_FILE
	procd_close_instance
	
	echo "PanSou服务已启动"
}

stop_service() {
	echo "PanSou服务已停止"
}

reload_service() {
	stop
	start
}

service_triggers() {
	procd_add_reload_trigger "pansou"
}
